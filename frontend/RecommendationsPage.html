<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>DestinAI - Top Recommendations</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            gray: {
              900: '#1a202c',
              800: '#2d3748',
            }
          }
        }
      }
    }
  </script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap");

    body {
      font-family: "Inter", sans-serif;
      background-color: #f3f4f6;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .fade-anim {
      animation: fadeIn 0.4s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card-shadow {
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
        0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
  </style>
</head>

<body
  class="min-h-screen flex flex-col items-center justify-center p-4 relative dark:bg-slate-900 transition-colors duration-300">
  <h1
    class="text-4xl md:text-5xl font-extrabold text-gray-900 dark:text-white mb-8 text-center tracking-tight z-10 transition-colors duration-300">
    Top 5 Recommendations
  </h1>

  <div
    class="relative w-full max-w-2xl bg-white dark:bg-slate-800 rounded-[2rem] card-shadow overflow-hidden flex flex-col min-h-[550px] z-10 transition-colors duration-300">

    <div id="loadingSection"
      class="absolute inset-0 z-50 bg-white dark:bg-slate-800 flex flex-col items-center justify-center transition-colors duration-300">
      <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
      <p class="text-gray-500 dark:text-gray-400 font-semibold">
        AI is analyzing your preferences...
      </p>
    </div>


    <div id="cardContent" class="flex flex-col w-full h-full fade-anim">

      <div class="relative w-full h-80 bg-gray-200 dark:bg-slate-700">
        <img id="cityImage" src="" alt="City" class="w-full h-full
          object-cover"
          onerror="this.src='https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?q=80&w=800&auto=format&fit=crop'" />

        <div
          class="absolute top-6 left-6 bg-white/95 dark:bg-slate-800/95 backdrop-blur px-4 py-2 rounded-full shadow-md">
          <span class="text-indigo-800 dark:text-indigo-300 font-bold text-sm tracking-wide">
            <span id="matchScore">--</span>% Match
          </span>
        </div>
      </div>

      <div
        class="flex-grow flex flex-col items-center justify-center text-center p-8 bg-white dark:bg-slate-800 transition-colors duration-300">

        <h2 id="cityName"
          class="text-5xl font-black text-gray-900 dark:text-white mb-6 tracking-tight transition-colors duration-300">

        </h2>

        <button id="selectBtn"
          class="bg-[#4F46E5] hover:bg-indigo-700 text-white text-lg font-bold py-4 px-10 rounded-full shadow-xl transition transform hover:scale-105 active:scale-95 mb-6">
          Select This Destination
        </button>

        <div class="flex gap-2" id="dotsContainer">
        </div>
      </div>
    </div>

    <button id="prevBtn"
      class="absolute left-4 top-1/2 -translate-y-1/2 z-20 bg-white/80 dark:bg-slate-700/80 hover:bg-white dark:hover:bg-slate-600 text-gray-800 dark:text-white p-4 rounded-full shadow-lg transition hover:scale-110 focus:outline-none backdrop-blur-sm">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"
        class="w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
      </svg>
    </button>

    <button id="nextBtn"
      class="absolute right-4 top-1/2 -translate-y-1/2 z-20 bg-white/80 dark:bg-slate-700/80 hover:bg-white dark:hover:bg-slate-600 text-gray-800 dark:text-white p-4 rounded-full shadow-lg transition hover:scale-110 focus:outline-none backdrop-blur-sm">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"
        class="w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
      </svg>
    </button>
  </div>
  <script src="js/config.js"></script>
  <script src="js/theme-toggle.js"></script>

  <script>
    const loadingSection = document.getElementById("loadingSection");
    const cardContent = document.getElementById("cardContent");
    const cityImage = document.getElementById("cityImage");
    const matchScore = document.getElementById("matchScore");
    const cityName = document.getElementById("cityName");
    const dotsContainer = document.getElementById("dotsContainer");
    const selectBtn = document.getElementById("selectBtn");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    let recommendations = [];
    let currentIndex = 0;

    document.addEventListener("DOMContentLoaded", async () => {

      const savedPreferences = localStorage.getItem("userPreferences");

      if (!savedPreferences) {
        showError("No preferences found.", "Please start over from the planning page.");
        return;
      }

      try {
        const prefsCtx = JSON.parse(savedPreferences);
        const response = await fetch(`${CONFIG.API_BASE_URL}/api/recommend`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ preferences: prefsCtx.model_input }),
        });

        if (!response.ok) {
          const errText = await response.text();
          throw new Error(`Server Error (${response.status}): ${errText}`);
        }

        const data = await response.json();
        console.log("API Response:", data);

        if (data.recommendations && data.recommendations.length > 0) {

          recommendations = data.recommendations.map(validation => {

            let score = Math.max(70, Math.round(100 - (validation.distance * 10)));

            return {
              id: validation.details?.id || 0,
              name: validation.city,
              image: validation.details?.city_photo || `https://source.unsplash.com/800x600/?${encodeURIComponent(validation.city)},landmark,travel`,
              score: score,
              raw: validation
            };
          });

          loadingSection.classList.add("hidden");
          renderCard(0);
        } else {
          throw new Error("Backend returned empty recommendations list.");
        }

      } catch (error) {
        showError("Error loading data", error.message);
      }
    });

    function showError(title, message) {
      console.error("Critical Error:", title, message);
      loadingSection.innerHTML = `
            <div class='text-center p-8 bg-white dark:bg-slate-800 rounded-xl shadow-lg max-w-lg mx-auto border border-red-100 dark:border-red-900'>
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 dark:bg-red-900 mb-6">
                    <svg class="w-8 h-8 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 class='text-xl font-bold text-gray-900 dark:text-white mb-2'>${title}</h3>
                <p class='text-gray-600 dark:text-gray-300 mb-6'>We couldn't load your recommendations.</p>
                
                <div class="bg-gray-50 dark:bg-slate-900 rounded-lg p-4 mb-6 text-left overflow-x-auto">
                    <p class='text-xs font-mono text-red-500 break-all'>${message}</p>
                </div>

                <div class="flex gap-4 justify-center">
                    <a href='PlanningPage.html' class='px-6 py-2 bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-200 font-medium rounded-lg hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors'>Go Back</a>
                    <button onclick="window.location.reload()" class='px-6 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors shadow-sm hover:shadow-md'>Try Again</button>
                </div>
            </div>`;
    }

    async function renderCard(index) {
      if (!recommendations[index]) return;
      const city = recommendations[index];

      cardContent.classList.remove("fade-anim");
      void cardContent.offsetWidth;
      cardContent.classList.add("fade-anim");

      const fallbackImg = "https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?q=80&w=800&auto=format&fit=crop";

      cityImage.src = city.image || fallbackImg;

      cityImage.onerror = () => {
        cityImage.src = fallbackImg;
      };

      matchScore.textContent = city.score;
      cityName.textContent = city.name;

      dotsContainer.innerHTML = "";
      recommendations.forEach((_, idx) => {
        const dot = document.createElement("div");

        if (idx === index) {
          dot.className = "w-3 h-3 rounded-full bg-[#4F46E5] transition-all";
        } else {
          dot.className = "w-3 h-3 rounded-full bg-gray-300 dark:bg-slate-600 transition-all";
        }
        dotsContainer.appendChild(dot);
      });
    }

    function goNext() {
      if (recommendations.length === 0) return;
      currentIndex = currentIndex < recommendations.length - 1 ? currentIndex + 1 : 0;
      renderCard(currentIndex);
    }

    function goPrev() {
      if (recommendations.length === 0) return;
      currentIndex = currentIndex > 0 ? currentIndex - 1 : recommendations.length - 1;
      renderCard(currentIndex);
    }

    prevBtn.addEventListener("click", goPrev);
    nextBtn.addEventListener("click", goNext);

    document.addEventListener("keydown", (e) => {
      if (!loadingSection.classList.contains("hidden")) return;
      if (e.key === "ArrowRight") goNext();
      if (e.key === "ArrowLeft") goPrev();
    });

    selectBtn.addEventListener("click", () => {
      const selectedCity = recommendations[currentIndex];

      let prefs = JSON.parse(localStorage.getItem("userPreferences")) || {};
      prefs.cityId = selectedCity.id;
      prefs.cityName = selectedCity.name;
      localStorage.setItem("userPreferences", JSON.stringify(prefs));
      window.location.href = "FinalPage.html";
    });
  </script>
</body>

</html>